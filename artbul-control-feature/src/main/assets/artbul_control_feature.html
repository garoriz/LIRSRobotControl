<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>ArtBul</title>
    <script src="https://cdn.jsdelivr.net/npm/roslib/build/roslib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.8.0/dist/nipplejs.min.js"></script>
    <style>
        body {
          margin: 0;
          font-family: sans-serif;
          background-color: #f4f4f4;
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 16px;
        }
        h1 {
          font-size: 24px;
          margin-bottom: 10px;
          text-align: center;
        }
        #connect-section {
          width: 100%;
          max-width: 420px;
          display: flex;
          flex-direction: column;
          align-items: center;
          margin-bottom: 20px;
        }
        #ipInput {
          width: 100%;
          font-size: 18px;
          padding: 10px;
          margin-bottom: 12px;
          border-radius: 8px;
          border: 1px solid #ccc;
          box-sizing: border-box;
        }
        button {
          font-size: 18px;
          padding: 10px 20px;
          border: none;
          border-radius: 8px;
          background-color: #007bff;
          color: white;
          cursor: pointer;
          width: 100%;
        }
        button:hover {
          background-color: #0056b3;
        }
        #status {
          margin-top: 12px;
          font-size: 16px;
          text-align: center;
          min-height: 24px;
        }
        #mode-control {
          margin: 16px 0;
          font-size: 16px;
          max-width: 420px;
          width: 100%;
          text-align: center;
        }
        #modeSelect {
          font-size: 16px;
          padding: 6px 10px;
          border-radius: 6px;
          border: 1px solid #ccc;
          cursor:
          pointer;
        }

        #joystick-single {
          width: 60vw;
          max-width: 300px;
          height: 60vw;
          max-height: 300px;
          background-color: #fff;
          border-radius: 16px;
          box-shadow: 0 0 8px rgba(0,0,0,0.1);
          position: relative;
          touch-action: none;
          margin: 10px auto;
        }

        #joystick-move, #joystick-rotate {
          width: 40vw;
          max-width: 300px;
          height: 40vw;
          max-height: 300px;
          background-color: #fff;
          border-radius: 16px;
          box-shadow: 0 0 8px rgba(0,0,0,0.1);
          position: relative;
          touch-action: none;
          margin: 5px auto;
        }
        #joystick-dual {
          display: flex;
          justify-content: space-between;
          width: 100%;
          padding: 0 10 px;
          box-sizing: border-box;
        }

        #lidarCanvas {
          width: 300px;
          height: 300px;
          background: #000;
          border-radius: 10px;
          margin-top: 20px;
        }

        .joystick-wrapper {
          display: flex;
          flex-direction: column;
          align-items: center;
        }

        .joystick-label {
          margin-top: 8px;
          font-size: 16px;
          font-weight: bold;
          color: #333;
          text-align: center;
        }

        #button-controls button {
          font-size: 20px;
          padding: 12px 20px;
          margin: 5px;
          border: none;
          border-radius: 10px;
          background-color: #444;
          color: white;
          cursor: pointer;
          min-width: 100px;
        }
        #button-controls button:hover {
          background-color: #000;
        }

        .control-grid {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 12px;
        }

        .control-grid .row {
          display: flex;
          gap: 12px;
        }

        .control-grid .row.center {
          justify-content: center;
        }

        .control-grid button {
          font-size: 20px;
          padding: 14px 20px;
          min-width: 110px;
          border: none;
          border-radius: 10px;
          background-color: #444;
          color: white;
          cursor: pointer;
          text-align: center;
        }

        .control-grid button:hover {
          background-color: #000;
        }
    </style>
</head>
<body>

<h1>ArtBul</h1>

<div id="connect-section">
    <input type="text" id="ipInput" placeholder="Enter the IP of the robot (e.g. 192.168.1.42)"
           required
           oninput="filterIP(this)" maxlength="15" inputmode="decimal"/>
    <button onclick="connectToRos()">Connect</button>
    <div id="status">Not connected</div>
</div>

<div id="mode-control">
    <label for="modeSelect"><b>Control mode:</b></label>
    <select id="modeSelect" onchange="changeMode()">
        <option value="single">One joystick</option>
        <option value="dual">Two joysticks</option>
        <option value="buttons">Buttons</option>
    </select>
</div>

<canvas id="lidarCanvas" width="300" height="300"
        style="background: #000; border-radius: 10px; margin-top: 20px;"></canvas>

<div id="joystick-single"></div>

<div id="joystick-dual" style="display: none;">
    <div class="joystick-wrapper">
        <div id="joystick-move"></div>
        <div class="joystick-label">Movement</div>
    </div>
    <div class="joystick-wrapper">
        <div id="joystick-rotate"></div>
        <div class="joystick-label">Turning</div>
    </div>
</div>

<div id="button-controls" style="display: none; margin-top: 20px;">
    <div class="control-grid">
        <div class="row center">
            <button onclick="drive('forward')">⬆ Forward</button>
        </div>
        <div class="row">
            <button onclick="drive('left')">⬅ To the left</button>
            <button onclick="drive('stop')">⏹ Stop</button>
            <button onclick="drive('right')">➡ To the right</button>
        </div>
        <div class="row center">
            <button onclick="drive('backward')">⬇ Back</button>
        </div>
    </div>
</div>

<script>
    let ros = null;
    let cmdVelPub = null;

    let linearX = 0.0;
    let linearY = 0.0;
    let angularZ = 0.0;

    let singleJoystickInstance = null;
    let moveJoystickInstance = null;
    let rotateJoystickInstance = null;

    let lidarSub = null;
    const canvas = document.getElementById('lidarCanvas');
    const ctx = canvas.getContext('2d');

    function drawLidar(scan) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const cx = canvas.width / 2;
      const cy = canvas.height / 2;

      const robotRadius = 8;

      ctx.beginPath();
      ctx.arc(cx, cy, robotRadius, 0, 2 * Math.PI);
      ctx.fillStyle = '#007bff';
      ctx.fill();
      ctx.closePath();

      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(cx, cy - 20);
      ctx.strokeStyle = 'blue';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.closePath();

      ctx.save();
      ctx.translate(canvas.width / 2, canvas.height / 2);

      const scale = 100;

      for (let i = 0; i < scan.ranges.length; i++) {
        const angle = scan.angle_min + i * scan.angle_increment;
        const r = scan.ranges[i];

        if (r < scan.range_min || r > scan.range_max || !isFinite(r)) continue;

        const x = r * Math.cos(angle + Math.PI / 2) * scale;
        const y = r * Math.sin(angle + Math.PI / 2) * scale;

        ctx.fillStyle = '#00ff00';
        ctx.beginPath();
        ctx.arc(x, -y, 2, 0, 2 * Math.PI);
        ctx.fill();
      }

      ctx.restore();
    }

    function filterIP(input) {
      input.value = input.value.replace(/[^0-9.]/g, '');
    }

    function connectToRos() {
      const ip = document.getElementById("ipInput").value.trim();
      if (!ip) {
        alert("Enter the IP address of the robot!");
        return;
      }

      const url = `ws://${ip}:9090`;
      ros = new ROSLIB.Ros({ url: url });

      ros.on('connection', () => {
        document.getElementById('status').innerText = `Connected to ${url}`;
        setupPublisher();
        subscribeToLidar();
      });

      ros.on('error', (error) => {
        document.getElementById('status').innerText = `Connection error: ${error}`;
        console.error(error);
      });

      ros.on('close', () => {
        document.getElementById('status').innerText = `Connection closed`;
      });
    }

    function setupPublisher() {
      cmdVelPub = new ROSLIB.Topic({
        ros: ros,
        name: '/artbul/mobile_base_controller/cmd_vel',
        messageType: 'geometry_msgs/msg/TwistStamped'
      });
    }

    function activateSingleJoystick() {
      if (moveJoystickInstance) {
        moveJoystickInstance.destroy();
        moveJoystickInstance = null;
      }
      if (rotateJoystickInstance) {
        rotateJoystickInstance.destroy();
        rotateJoystickInstance = null;
      }
      document.getElementById('joystick-single').style.display = 'block';
      document.getElementById('joystick-dual').style.display = 'none';

      if (singleJoystickInstance) singleJoystickInstance.destroy();

      singleJoystickInstance = nipplejs.create({
        zone: document.getElementById('joystick-single'),
        mode: 'static',
        position: { left: '50%', top: '50%' },
        color: 'blue',
        size: 200
      });

      singleJoystickInstance.on('move', (evt, data) => {
        if (!cmdVelPub || !ros || !ros.isConnected) return;
        if (data && data.angle && typeof data.angle.radian === 'number') {
          const angle = data.angle.radian;
          const distance = data.distance || 0;

          const maxSpeed = 1;
          linearX = Math.sin(angle) * distance * 0.01 * maxSpeed;
          angularZ = -Math.cos(angle) * distance * 0.1 * maxSpeed;
        }
      });

      singleJoystickInstance.on('end', () => {
        linearX = 0.0;
        angularZ = 0.0;
      });
    }

    function activateDualJoystick() {
      if (singleJoystickInstance) {
        singleJoystickInstance.destroy();
        singleJoystickInstance = null;
      }

      if (moveJoystickInstance) moveJoystickInstance.destroy();
      if (rotateJoystickInstance) rotateJoystickInstance.destroy();

      moveJoystickInstance = nipplejs.create({
        zone: document.getElementById('joystick-move'),
        mode: 'static',
        position: { left: '50%', top: '50%' },
        color: 'blue',
        size: 125
      });

      rotateJoystickInstance = nipplejs.create({
        zone: document.getElementById('joystick-rotate'),
        mode: 'static',
        position: { left: '50%', top: '50%' },
        color: 'green',
        size: 125
      });

      moveJoystickInstance.on('move', (evt, data) => {
        if (data && data.angle) {
          const angle = data.angle.radian;
          const distance = data.distance || 0;
          linearX = Math.sin(angle) * distance * 0.02;
          linearY = Math.cos(angle) * distance * 0.02;
        }
      });

      moveJoystickInstance.on('end', () => {
        linearX = 0.0;
        linearY = 0.0;
      });

      rotateJoystickInstance.on('move', (evt, data) => {
        if (data && data.angle) {
          const angle = data.angle.radian;
          const distance = data.distance || 0;

          angularZ = -Math.cos(angle) * distance * 0.1;
        }
      });

      rotateJoystickInstance.on('end', () => {
        angularZ = 0.0;
      });
    }

    document.getElementById("modeSelect").addEventListener("change", (e) => {
      if (e.target.value === "single") {
        activateSingleJoystick();
      } else if (e.target.value === "dual") {
        activateDualJoystick();
      }
    });

    function changeMode() {
      const mode = document.getElementById('modeSelect').value;
      document.getElementById('joystick-single').style.display = (mode === 'single') ? 'block' : 'none';
      document.getElementById('button-controls').style.display = (mode === 'buttons') ? 'block' : 'none';
      document.getElementById('joystick-dual').style.display = (mode === 'dual') ? 'flex' : 'none';
    }

    setInterval(() => {
      if (!cmdVelPub || !ros || !ros.isConnected) return;

      const now = Date.now();
      const sec = Math.floor(now / 1000);
      const nanosec = (now % 1000) * 1e6;

      const msg = new ROSLIB.Message({
        header: {
          stamp: { sec: sec, nanosec: nanosec },
          frame_id: 'base_link'
        },
        twist: {
          linear: { x: linearX, y: linearY || 0.0, z: 0.0 },
          angular: { x: 0.0, y: 0.0, z: angularZ }
        }
      });

      cmdVelPub.publish(msg);
    }, 100);
    activateSingleJoystick();

    function subscribeToLidar() {
      lidarSub = new ROSLIB.Topic({
        ros: ros,
        name: '/artbul/scan',
        messageType: 'sensor_msgs/msg/LaserScan'
      });

      lidarSub.subscribe(drawLidar);
    }

    function drive(direction) {
      switch (direction) {
        case 'forward':
          linearX = 1.0;
          angularZ = 0.0;
          break;
        case 'backward':
          linearX = -1.0;
          angularZ = 0.0;
          break;
        case 'left':
          linearX = 0.0;
          angularZ = 1.2;
          break;
        case 'right':
          linearX = 0.0;
          angularZ = -1.2;
          break;
        case 'stop':
        default:
          linearX = 0.0;
          angularZ = 0.0;
          return;
      }
    }

    function sendDriveCommand() {
      if (!publisher || !ros || !ros.isConnected) return;

      const now = Date.now();
      const sec = Math.floor(now / 1000);
      const nanosec = (now % 1000) * 1e6;

      const msg = new ROSLIB.Message({
        header: {
          stamp: { sec: sec, nanosec: nanosec },
          frame_id: "base_link"
        },
        drive: {
          steering_angle: steering,
          speed: speed
        }
      });

      publisher.publish(msg);
    }
</script>
</body>
</html>
