<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–≤—Ä–æ—Ä–∞ –Æ–Ω–∏–æ—Ä ‚Äî –î–∂–æ–π—Å—Ç–∏–∫</title>
  <script src="https://cdn.jsdelivr.net/npm/roslib/build/roslib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.8.0/dist/nipplejs.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      background-color: #f0f0f0;
    }

    h1 {
      margin: 20px;
      font-size: 24px;
    }

    #status {
      font-weight: bold;
      margin-top: 10px;
      font-size: 18px;
    }

    #connect-block {
      margin: 20px;
    }

    #ipInput {
      font-size: 20px;
      padding: 14px 12px;
      width: 250px;
      border: 1px solid #ccc;
      border-radius: 10px;
      margin-bottom: 12px;
    }

    #connect-block button {
      font-size: 20px;
      padding: 14px 24px;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 10px;
      cursor: pointer;
    }

    #connect-block button:hover {
      background-color: #0056b3;
    }

    #joystick {
      width: 300px;
      height: 300px;
      margin: 40px auto;
      touch-action: none;
    }
  </style>
</head>
<body>

<h1>üöó –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Avrora Unior</h1>

<div id="connect-block">
  <input type="text" id="ipInput" placeholder="IP –º–∞—à–∏–Ω—ã">
  <br>
  <button onclick="connect()">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
  <div id="status">‚õî –û—Ç–∫–ª—é—á–µ–Ω–æ</div>
</div>

<div id="joystick"></div>

<script>
  let ros = null;
  let publisher = null;

  let steering = 0.0;
  let speed = 0.0;

  function connect() {
    const ip = document.getElementById("ipInput").value.trim();
    if (!ip) return alert("–í–≤–µ–¥–∏—Ç–µ IP ROS-–º–∞—à–∏–Ω—ã");

    ros = new ROSLIB.Ros({ url: `ws://${ip}:9090` });

    ros.on('connection', () => {
      document.getElementById('status').textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
      document.getElementById('status').style.color = 'green';

      publisher = new ROSLIB.Topic({
        ros: ros,
        name: '/junior_car/ackermann_cmd',
        messageType: 'ackermann_msgs/msg/AckermannDriveStamped'
      });
    });

    ros.on('error', err => {
      document.getElementById('status').textContent = '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
      document.getElementById('status').style.color = 'red';
      console.error(err);
    });

    ros.on('close', () => {
      document.getElementById('status').textContent = 'üîå –û—Ç–∫–ª—é—á–µ–Ω–æ';
      document.getElementById('status').style.color = 'gray';
    });
  }

  const joystick = nipplejs.create({
    zone: document.getElementById('joystick'),
    mode: 'static',
    position: { left: '50%', top: '50%' },
    color: 'blue',
    size: 200
  });

  joystick.on('move', (evt, data) => {
    if (!publisher || !ros || !ros.isConnected) return;
    if (!data.angle || typeof data.angle.radian !== 'number') return;

    const angle = data.angle.radian;
    const distance = data.distance || 0;

    speed = Math.sin(angle) * distance * 0.04;
    steering = -Math.cos(angle) * distance * 0.01;

    sendDriveCommand();
  });

  joystick.on('end', () => {
    speed = 0.0;
    steering = 0.0;
    sendDriveCommand();
  });

  function sendDriveCommand() {
    if (!publisher || !ros || !ros.isConnected) return;

    const now = Date.now();
    const sec = Math.floor(now / 1000);
    const nanosec = (now % 1000) * 1e6;

    const msg = new ROSLIB.Message({
      header: {
        stamp: { sec: sec, nanosec: nanosec },
        frame_id: "base_link"
      },
      drive: {
        steering_angle: steering,
        speed: speed
      }
    });

    publisher.publish(msg);
  }
</script>

</body>
</html>
